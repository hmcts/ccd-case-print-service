#!groovy

properties([
    // H allow predefined but random minute see https://en.wikipedia.org/wiki/Cron#Non-standard_characters
    //CCD-3539 (Stop running Nightly builds on weekends). Original schedule was 'H 05 * * *'
    pipelineTriggers([cron('H 8 * * 1-5')])
])

@Library("Infrastructure")

def type = "nodejs"
def product = "ccd"
def component = "case-print-service"

withNightlyPipeline(type, product, component) {
    enableSlackNotifications('#ccd-nightly-builds')

    enableFortifyScan()
    afterAlways('fortify-scan') {
        steps.archiveArtifacts allowEmptyArchive: true, artifacts: '**/Fortify Scan/**/*'
    }

    afterAlways('checkout') {
        sh '''
          set -e
          BIN_DIR="$WORKSPACE/.local/bin"
          mkdir -p "$BIN_DIR"
          cat <<'SCRIPT' > "$BIN_DIR/yarn"
#!/usr/bin/env bash
set -e
exec node "$WORKSPACE/.yarn/releases/yarn-4.9.3.cjs" "$@"
SCRIPT
          cat <<'SCRIPT' > "$BIN_DIR/yarnpkg"
#!/usr/bin/env bash
set -e
exec node "$WORKSPACE/.yarn/releases/yarn-4.9.3.cjs" "$@"
SCRIPT
          chmod +x "$BIN_DIR/yarn" "$BIN_DIR/yarnpkg"
        '''
        env.PATH = "${env.WORKSPACE}/.local/bin:${env.PATH}"
        sh "yarn cache clean"
    }

}
